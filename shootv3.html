<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<style>
		* {
			margin:0;
			padding:0;
		}
	</style>
</head>
	<body>
		<canvas id = 'canvas' width = '1250' height = '800' ></canvas>
		
		<p id="demo"></p>
		<script>

			var demo = document.getElementById('demo');

			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
			canvas.style.cursor = 'crosshair';

			var ch = canvas.height;
			var cw = canvas.width;

			var startingX = canvas.width / 2;
			var startingY = canvas.height / 2;
			var x2;
			var y2;
			var angle;

			var vectorX;
			var vectorY;
			canvas.addEventListener('mousemove', function(e) {

				var vectorX = e.offsetX - (soldier.x +w);
				var vectorY = e.offsetY - (soldier.y +h);
				var mod = Math.sqrt(vectorX ** 2 + vectorY ** 2);
				
				angle = Math.atan2(vectorY, vectorX)-.2;
				
				demo.innerHTML = 
								 'angle ' + angle + '</br>'+
								 'degrees ' + angle * (180 / Math.PI) + '</br>'+
								
								 'screenx ' + e.clientX + '</br>'+
								 'screeny ' + e.clientY + '</br>';				 
			});
			canvas.addEventListener('mousedown', function(e) {

			})
			document.addEventListener('keydown', function(e) {

				switch(e.key) {

					case 'ArrowDown': soldier.down = true;soldier.actio('move'); soldier.feet ='walk'; //soldier.y += soldier.speed;//soldier.move(0, 1);
						break;
					case 'ArrowUp': soldier.up = true;soldier.actio('move'); soldier.feet = 'walk'; //soldier.y -= soldier.speed;//soldier.move(0, -1);
						break;
					case 'ArrowLeft': soldier.left = true;soldier.actio('move'); soldier.feet = 'left'; //soldier.x -= soldier.speed;//soldier.move(-1, 0);
						break;
					case 'ArrowRight': soldier.right = true;soldier.actio('move'); soldier.feet = 'right'; //soldier.x+= soldier.speed;//soldier.x += 5; console.log('ri'); console.log(soldier.x)//soldier.move(1, 0);
						break;
					case ' ': if (soldier.r != true) { 
													   soldier.actio('shoot');
													   ctx.save();
													   ctx.translate(soldier.x +w, soldier.y+h);
													   ctx.rotate(angle);
													   if (soldier.current == 'handgun') {
													   		ctx.drawImage(light, 0, 0,light.width, light.height, w - 10, -h/2 - 3 , light.width / 4, light.height / 4);
													   } else if (soldier.current == 'shotgun' || soldier.current == 'rifle') {
														    ctx.drawImage(light, 0, 0,light.width, light.height, w + 4, -h/2 - 6, light.width / 4, light.height / 4);
													   }
													   ctx.restore();
													 }
						break;
					case 'k': soldier.gun('knife');
						break;
					case 'a': soldier.gun('rifle');
						break;
					case 's': soldier.gun('shotgun');
						break;
					case 'h': soldier.gun('handgun');
						break;
					case 'f': soldier.gun('flashlight');
						break;
					case 'r': soldier.actio('reload');
						break;
					case 'm': soldier.actio('meleeattack');
						break;
					default: soldier.actio('idle');soldier.feet('idle');
				}
			});
			document.addEventListener('keyup', function(e) {

				switch(e.key) {

					case 'ArrowDown': soldier.feet = 'idle';soldier.down = false;
						break;
					case 'ArrowUp': soldier.feet = 'idle'; soldier.up = false;
						break;
					case 'ArrowLeft': soldier.feet = 'idle';soldier.left = false;
						break;
					case 'ArrowRight': soldier.feet = 'idle';soldier.right = false;
						break;

				}

			});
{
			var audio = {

					fx:
					{
							argh:
							{
								src: 
								[
									 'aargh/aargh0.ogg',
									 'aargh/aargh1.ogg',
									 'aargh/aargh2.ogg',
									 'aargh/aargh3.ogg',
									 'aargh/aargh4.ogg',
									 'aargh/aargh5.ogg',
									 'aargh/aargh6.ogg',
									 'aargh/aargh7.ogg'
								],
								audio: []
							},
							vsgame0:
							{
								src:
								[
									 'vsgame_0/round_end.wav',
									 'vsgame_0/death.wav'
								],
									audio: []
							},
							goblin:
							{
									src:
									['GoblinDeath.wav'],
									audio: []
							},
							up:
							{
									src:
									['up/upshort.wav'],
									audio: []
							},
							guns:
							{
								src:
								[	'shots/cg1.wav',
									'shots/pistol.wav',
									'shots/rifle.wav',
									'shots/shotgun.wav'
								],
									audio: []
							},
							zombie:
							{
								src:
								[
									'zombie/zombie-16.wav',
									'zombie/zombie-22.wav',
									'zombie/zombie-19.wav',
									'zombie/zombie-17.wav',
									'zombie/zombie-13.wav'
								],
								audio: []
							}
					},
					ost: 
					{
							ost:
							{
							src:
		                           [
									  'vaerionii.mp3',
									  'BlitzKaskade.mp3',
									  'DST-RailJet[qubodupshort-cutloop].ogg',
									  'forest.ogg',
									  'JRPGOST/01-Opening.ogg',
									  'JRPGOST/02-BWV1007-Prelude.ogg',
									  'JRPGOST/03-HWV56-Whydothenationssofuriouslyragetogether.ogg',
									  'JRPGOST/04-Sanctuary.ogg',
									  'JRPGOST/05-Reunion.ogg',
									  'JRPGOST/06-RebelsBe.ogg',
									  'JRPGOST/07-Town.ogg',
									  'JRPGOST/08-Overworld.ogg',
									  'JRPGOST/09-Z339-HeretheDeitiesapprove.ogg',
									  'JRPGOST/10-The Empire.ogg',
									  'JRPGOST/11-Ostrich!.ogg',
									  'JRPGOST/12-TimewornPagoda.ogg',
									  'JRPGOST/13-Danger.ogg',
									  'JRPGOST/14-BarbarianKing.ogg',
									  'JRPGOST/15-Dungeon.ogg',
									  'JRPGOST/16-EntertheEmperor.ogg',
									  'JRPGOST/17-Victory.ogg',
									  'JRPGOST/18-NighttideWaltz.ogg',
									  'JRPGOST/19-Courtesan.ogg',
									  'JRPGOST/20-GameOver.ogg',
									  'JRPGOST/21-Fanfare.ogg',
									  'JRPGOST/22-ANewComrade.ogg',
									  'JRPGOST/23-Inn.ogg',
									  'JRPGOST/24-RV610-Fecitpotentiam.ogg',
									  'JRPGOST/25-Finale.ogg'
								   ],
							audio : []
						}
					}	
			}
			for (el in audio) {
				
				for (el2 in audio[el]) {

					for (var i = 0; i < audio[el][el2]['src'].length; i++) {

						var audioVar = new Audio();
						audioVar.src = audio[el][el2]['src'][i];
						audio[el][el2]['audio'].push(audioVar);
					}
				}
			}

			var sprites = 
			{
					flashlight:
					{		
							meleeattack: 
							{
								number: 15,
								src: 'Top_Down_Survivor/flashlight/meleeattack/survivor-meleeattack_flashlight_',
								sprite:[]
							},
							idle:
							{
								number: 20,
								src: 'Top_Down_Survivor/flashlight/idle/survivor-idle_flashlight_',
								sprite:[]
							},
							move:
							{
								number: 20,
								src: 'Top_Down_Survivor/flashlight/move/survivor-move_flashlight_',
								sprite:[]
							}
					},
					knife: 
					{
							meleeattack: 
							{
								number: 15,
								src: 'Top_Down_Survivor/knife/meleeattack/survivor-meleeattack_knife_',
								sprite:[]
							},
							idle:
							{
								number: 20,
								src: 'Top_Down_Survivor/knife/idle/survivor-idle_knife_',
								sprite:[]
							},
							move:
							{
								number: 20,
								src: 'Top_Down_Survivor/knife/move/survivor-move_knife_',
								sprite:[]
							}					
					},
					shotgun:
					{
							meleeattack: 
							{
								number: 15,
								src: 'Top_Down_Survivor/shotgun/meleeattack/survivor-meleeattack_shotgun_',
								sprite:[]
							},
							idle:
							{
								number: 20,
								src: 'Top_Down_Survivor/shotgun/idle/survivor-idle_shotgun_',
								sprite:[]
							},
							move:
							{
								number: 20,
								src: 'Top_Down_Survivor/shotgun/move/survivor-move_shotgun_',
								sprite:[]
							},
							shoot:
							{
								number: 3,
								src: 'Top_Down_Survivor/shotgun/shoot/survivor-shoot_shotgun_',
								sprite:[]
							},
							reload:
							{
								number: 20,
								src: 'Top_Down_Survivor/shotgun/reload/survivor-reload_shotgun_',
								sprite:[]
							}
					},
					rifle:
					{
							meleeattack: 
							{
								number: 15,
								src: 'Top_Down_Survivor/rifle/meleeattack/survivor-meleeattack_rifle_',
								sprite:[]
							},
							idle:
							{
								number: 20,
								src: 'Top_Down_Survivor/rifle/idle/survivor-idle_rifle_',
								sprite:[]
							},
							move:
							{
								number: 20,
								src: 'Top_Down_Survivor/rifle/move/survivor-move_rifle_',
								sprite:[]
							},
							shoot: 
							{
								number: 3,
								src: 'Top_Down_Survivor/rifle/shoot/survivor-shoot_rifle_',
								sprite:[]
							},
							reload:
							{
								number: 20,
								src: 'Top_Down_Survivor/rifle/reload/survivor-reload_rifle_',
								sprite:[]
							}
					},
					handgun:
					{
							meleeattack: 
							{
								number: 15,
								src: 'Top_Down_Survivor/handgun/meleeattack/survivor-meleeattack_handgun_',
								sprite:[]
							},
							idle:
							{
								number: 20,
								src: 'Top_Down_Survivor/handgun/idle/survivor-idle_handgun_',
								sprite:[]
							},
							move:
							{
								number: 20,
								src: 'Top_Down_Survivor/handgun/move/survivor-move_handgun_',
								sprite:[]
							},
							shoot:
							{
								number: 3,
								src: 'Top_Down_Survivor/handgun/shoot/survivor-shoot_handgun_',
								sprite:[]
							},
							reload:
							{
								number: 15,
								src: 'Top_Down_Survivor/handgun/reload/survivor-reload_handgun_',
								sprite:[]
							}
					},
					feet:
					{
							walk:
							{
								number: 20,
								src: 'Top_Down_Survivor/feet/walk/survivor-walk_',
								sprite:[]
							},
							left:
							{
								number: 20,
								src: 'Top_Down_Survivor/feet/strafe_left/survivor-strafe_left_',
								sprite:[]
							},
							right:
							{
								number: 20,
								src: 'Top_Down_Survivor/feet/strafe_right/survivor-strafe_right_',
								sprite:[]
							},
							run:
							{
								number: 20,
								src: 'Top_Down_Survivor/feet/run/survivor-run_',
								sprite:[]
							},
							idle:
							{
								number: 1,
								src: 'Top_Down_Survivor/feet/idle/survivor-idle_',
								sprite:[]
							}
					}
			}
{		
			var light = new Image();
			light.src = 'image(4).png';
			var bulletFrame = new Image();
			bulletFrame.src = '1_HeroShotgunBulletFrames.gif';
			var enemySprite = new Image();
			enemySprite.src = 'zombie_topdown.png';
			var beam = new Image();
			beam.src = 'beams.png';
				
			for (what in sprites) {

				for (typ in sprites[what]) {

					for (var i = 0; i < sprites[what][typ]['number']; i++) {

						var imgVar = new Image();
						imgVar.src = sprites[what][typ]['src'] + i + '.png';

						sprites[what][typ]['sprite'].push(imgVar);	
					}
				}
			}
}
}		
			var h = ((sprites.handgun.idle.sprite[0].height) / 4) / 2;			
			var w = ((sprites.handgun.idle.sprite[0].width) / 4) / 2;

			var Shooter = function() {

				this.x = startingX;
				this.y = startingY;
				this.speed = 11;
				this.current = 'handgun';
				this.act = 'idle';
				this.feet = 'idle';
				this.up = false;
				this.down = false;
				this.left = false;
				this.right = false;
				this.rifle = 40;
				this.shotgun = 7;
				this.handgun = 11;
				this.r = false;


				var c = 0;
				this.bullets = {
					'rifle': 40,
					'shotgun': 7,
					'handgun': 11,
				};
				this.shooting = function() {
					if (this.act == 'shoot' && this.r == false) {
// 						if (this.current == 'handgun') {ctx.drawImage(light, 0, 0,light.width, light.height, w - 22, -h/2 + 47, light.width / 2, light.height / 2);
// }
						if (this.bullets[this.current] > 0) {
							this.bullets[this.current]--;
							console.log(this.bullets[this.current])

						} else if (this.bullets[this.current] == 0) {
							//this.act = 'reload';
							this.relo();
						}
					} 
				}
				this.relo = function() {

					if (this.bullets[this.current] == 0 || this.act == 'reload') {
							this.r = true;
							if (this.bullets[this.current] != this[this.current] && this.current != 'shotgun') {
								
								this.act = 'reload';
								this.bullets[this.current] += this[this.current];
								setTimeout(()=> {this.r = false;console.log('1segundo')}, 1000);	
							} else if (this.current == 'shotgun') {
								if (this.bullets[this.current] < this.shotgun) {
									this.act = 'reload';
									this.bullets[this.current]++;

								}
							}
					}

				}
				this.move = function() {
					if (this.up == true) {this.y -= this.speed}
					if (this.down == true) {this.y += this.speed}
					if (this.right == true) {this.x += this.speed}
					if (this.left == true) {this.x -= this.speed}
				}
				this.gun = (x)=> {

					switch(x) {
						case 'handgun': this.current = x;
							break;
						case 'shotgun': this.current = x;
							break;
						case 'flashlight': this.current = x;
							break;
						case 'knife': this.current = x;
							break;
						case 'rifle': this.current = x;
							break;
					}
				}
				this.actio = (x)=> {

					switch(x) {
						
						case 'reload': this.act = x;
							break;
						case 'shoot': this.act = x;
							break;
						case 'idle': this.act = x;
							break;
						case 'meleeattack': this.act = x;
							break;
						case 'move': this.act = x;
							break;
						case 'shoot': this.act = x;
							break;
					}
				}
				this.draw = function() {
					if (c < sprites.feet[this.feet].sprite.length) {
						if (this.feet == 'idle') {

							drawFeet(sprites.feet.idle.sprite[0])
						} else if (this.feet == 'walk') {
							drawFeet(sprites.feet.walk.sprite[c])

						} else if (this.feet == 'left') {
							drawFeet(sprites.feet.left.sprite[c])

						} else if (this.feet == 'right') {
							drawFeet(sprites.feet.right.sprite[c])
						}
					} else {
						drawFeet(sprites.feet[this.feet].sprite[0]);
					}

					if (c < sprites[this.current][this.act].sprite.length ) {

						draw(sprites[this.current][this.act].sprite[c]);
						 // if (this.act == 'shoot') {

						 // }

						c++;

						if (this.current == 'shotgun' && c >= sprites[this.current][this.act].sprite.length && this.bullets['shotgun'] != 7) {
							this.bullets['shotgun']++;
							c = 0
						} else if (this.current == 'shotgun' && this.bullets['shotgun'] == 7) {this.r = false;}
					} else {
					
						c = 0;
						if (this.act != 'reload' && this.act != 'shoot' && this.act != 'meleeattack') {
							draw(sprites[this.current][this.act].sprite[c]);
						} else {
							this.act = 'idle';
							draw(sprites[this.current][this.act].sprite[c]);
						}
					}		
					// draw(sprites.handgun.idle.sprite[0], -w, -h);
					// ctx.drawImage(light, 90, -70)
				}

				this.angle = function() {
					
				}
			}
			var soldier = new Shooter();
			// var enemy = function() {

			// }
			function loop() {

				clear();
				ctx.save();
				floor();
				soldier.move();
				soldier.shooting();
				//soldier.relo();
				ctx.translate(soldier.x +w, soldier.y+h)
				ctx.rotate(angle);

				soldier.draw();
				console.log(soldier.act)
				//if (soldier.current == 'handgun' && soldier.act == 'shoot') {										ctx.drawImage(light, 0, 0,light.width, light.height, w - 22, -h/2 + 47, light.width / 2, light.height / 2);
//}
				//ctx.drawImage(light, 0, 0,light.width, light.height, w - 22, -h/2 + 47, light.width / 2, light.height / 2);
				ctx.restore();
			}
			var fl = new Image();
			fl.src = 'textureStone.png';

			function floor() {

				for (var i = 0; i < canvas.height; i += fl.height / 4) {
					for (var j = 0; j < canvas.width; j += fl.width / 4) {
						ctx.drawImage(fl, 0, 0, fl.width, fl.height, j, i, fl.width / 4, fl.height / 4);
					}
				}

			}

			function rotate(angle) {

				ctx.rotate(angle);
			}
			function drawFeet(img) {

				ctx.drawImage(img, 0, 0, img.width, img.height, -w, -h / 2, img.width / 4, img.height / 4);
			}
			
			function draw(img, x, y) {

				ctx.drawImage(img, 0, 0, img.width, img.height, -w, -h, img.width / 4, img.height / 4);
			}
			function clear() {

				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			window.onload = function() {
				setInterval(function() {
					loop();}, 50);
			}
{
			var dibuja = function(x = 300, y=300) {
				ctx.drawImage(sprites.handgun.idle.sprite[0], x, y);
			}
			var rota = function(grados = 25) {
				ctx.rotate(grados *180/Math.PI)
			}
			var trans = function(x = 300, y=300) {
				ctx.translate(x, y)
			}
			var punto = function(x, y) {
				ctx.fillRect(x, y, 5, 5)
			}
			var linea = function(x0=0,y0=0,x1=cw,y1=ch) {
				ctx.beginPath()
				ctx.moveTo(x0,y0)
				ctx.lineTo(x1,y1)
				ctx.stroke()
			}
}
		</script>
	</body>

</html>